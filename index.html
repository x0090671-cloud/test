<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šå‘˜å‘¨æœŸç­–ç•¥é…ç½®å° (é™æ€å‘å¸ƒç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus/dist/index.full.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@element-plus/icons-vue"></script>

    <style>
        :root { --el-color-primary: #409EFF; }
        body { font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        
        .grid-container {
            display: grid;
            grid-template-columns: 140px repeat(4, 1fr);
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .stage-header { text-align: center; padding: 10px; background: #f9fafc; border-radius: 4px; border-bottom: 2px solid #e4e7ed; }
        .stage-title { font-weight: bold; font-size: 16px; color: #303133; }
        .stage-sub { font-size: 12px; color: #909399; margin-top: 4px; }
        .row-header { display: flex; align-items: center; justify-content: center; background: #545c64; color: #fff; border-radius: 6px; font-weight: bold; padding: 10px; text-align: center; font-size: 14px; min-height: 80px; }
        
        .strategy-card {
            background: #fff; border: 1px solid #dcdfe6; border-radius: 6px; padding: 15px; cursor: pointer; position: relative; transition: all 0.3s; display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .strategy-card:hover { border-color: #409EFF; box-shadow: 0 4px 12px rgba(64,158,255,0.2); transform: translateY(-2px); }
        .strategy-card.active { background-color: #ecf5ff; border-color: #b3d8ff; }
        .card-summary { font-size: 14px; font-weight: bold; color: #303133; text-align: center; margin-bottom: 8px; }
        .card-tags { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
        .chart-wrapper { grid-column: 2 / -1; height: 180px; margin-bottom: 10px; }
        .empty-text { color: #c0c4cc; font-size: 12px; text-align: center; }
        .btn-add { margin-top: 10px; width: 100%; border-style: dashed; }
        
        /* é¡¶éƒ¨æ“ä½œåŒº */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; max-width: 1400px; margin: 0 auto 20px auto; }
    </style>
</head>
<body>

<div id="app">
    <div class="top-bar">
        <h2 style="margin:0; color: #303133;">ä¼šå‘˜å‘¨æœŸç­–ç•¥çœ‹æ¿ (å‘å¸ƒç‰ˆ)</h2>
        <div>
            <!-- æ ¸å¿ƒåŠŸèƒ½æŒ‰é’® -->
            <el-button type="success" @click="exportDataCode" icon="DocumentCopy">
                ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆé…ç½®ä»£ç 
            </el-button>
            <el-tag type="info" style="margin-left: 10px;">
                é…ç½®å®Œæˆåç‚¹å‡»å·¦ä¾§æŒ‰é’®ï¼Œå°†ç”Ÿæˆçš„ä»£ç ç²˜è´´å› HTML æ–‡ä»¶å³å¯
            </el-tag>
        </div>
    </div>

    <div class="grid-container">
        <div></div>
        <div class="stage-header" v-for="stage in stages" :key="stage.key">
            <div class="stage-title">{{ stage.name }}</div>
            <div class="stage-sub">{{ stage.desc }}</div>
        </div>

        <div></div> 
        <div class="chart-wrapper" id="chart-container"></div>

        <template v-for="(product, pIndex) in products" :key="product.key">
            <div class="row-header">
                <div v-html="product.name.replace('\n', '<br>')"></div>
            </div>
            
            <div 
                v-for="(stage, sIndex) in stages" 
                :key="stage.key"
                class="strategy-card"
                :class="{ 'active': hasData(product.key, stage.key) }"
                @click="openEditor(product, stage)"
            >
                <div v-if="hasData(product.key, stage.key)">
                    <div class="card-summary">{{ getCellData(product.key, stage.key).summary }}</div>
                    <div class="card-tags">
                        <el-tag size="small" effect="plain" type="success">
                            {{ getCellData(product.key, stage.key).rules.length }} ä¸ªè§„åˆ™
                        </el-tag>
                    </div>
                </div>
                <div v-else class="empty-text">
                    <el-icon><Edit /></el-icon> ç‚¹å‡»ç¼–è¾‘
                </div>
            </div>
        </template>
    </div>

    <el-drawer v-model="drawerVisible" :title="currentTitle" size="45%">
        <div v-if="currentCell">
            <el-divider content-position="left">å¤–å±‚å±•ç¤º</el-divider>
            <el-form label-width="100px">
                <el-form-item label="ç­–ç•¥æ¦‚è¦">
                    <el-input v-model="currentCell.summary" placeholder="ä¾‹å¦‚ï¼šåˆ°æœŸå‰7å¤©å‘åˆ¸"></el-input>
                </el-form-item>
            </el-form>

            <el-divider content-position="left">ç»†åˆ†äººç¾¤è§„åˆ™</el-divider>
            <el-table :data="currentCell.rules" stripe style="width: 100%; border: 1px solid #ebeef5; border-radius:4px;">
                <el-table-column prop="segment" label="äººç¾¤ç»†åˆ†" width="140">
                    <template #default="scope">
                        <el-input v-model="scope.row.segment" size="small"></el-input>
                    </template>
                </el-table-column>
                <el-table-column prop="coupon" label="ä¼˜æƒ åˆ¸/åŠ¨ä½œ">
                    <template #default="scope">
                        <el-input v-model="scope.row.coupon" size="small"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="æ“ä½œ" width="80">
                    <template #default="scope">
                        <el-button type="danger" link @click="removeRule(scope.$index)">åˆ é™¤</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-button class="btn-add" type="primary" plain icon="Plus" @click="addRule">æ·»åŠ è§„åˆ™</el-button>
            
            <div style="margin-top: 40px; text-align: right;">
                <el-button type="primary" @click="saveTemp">ç¡®è®¤ä¿®æ”¹</el-button>
            </div>
        </div>
    </el-drawer>

    <!-- å¤åˆ¶ä»£ç çš„å¼¹çª— -->
    <el-dialog v-model="codeDialogVisible" title="å¤åˆ¶ä»£ç " width="50%">
        <p>è¯·å¤åˆ¶ä¸‹æ–¹ä»£ç ï¼Œç”¨è®°äº‹æœ¬æ‰“å¼€ index.htmlï¼Œæ‰¾åˆ° <b>const HARDCODED_DATA = ...</b> è¿™ä¸€è¡Œè¿›è¡Œæ›¿æ¢ï¼š</p>
        <el-input
            v-model="generatedCode"
            :rows="10"
            type="textarea"
            readonly
        ></el-input>
        <template #footer>
            <span class="dialog-footer">
                <el-button type="primary" @click="copyToClipboard">å¤åˆ¶å…¨éƒ¨ä»£ç </el-button>
            </span>
        </template>
    </el-dialog>
</div>

<script>
const { createApp, ref, onMounted } = Vue;
const { ElMessage } = ElementPlus;

// ==========================================
// ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ¯æ¬¡æ›´æ–°æ•°æ®ï¼Œåªéœ€è¦æ›¿æ¢ä¸‹é¢è¿™ä¸ªå¤§æ‹¬å·é‡Œçš„å†…å®¹ ğŸ‘‡ğŸ‘‡ğŸ‘‡
const HARDCODED_DATA = {
    "basic_month_free": {
        "summary": "29.8å…ƒé¦–è´­ä»·",
        "rules": []
    },
    "basic_year_free": {
        "summary": "399å…ƒé¦–è´­ä»·",
        "rules": []
    },
    "adv_month_free": {
        "summary": "79~89å…ƒé¦–è´­ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰",
        "rules": [
            {
                "segment": "å…è´¹æ´»è·ƒäººç¾¤",
                "coupon": "20å…ƒåˆ¸"
            },
            {
                "segment": "åŸºç¡€åŒ…æœˆåœ¨çº¦ ä¸” æœªè´­ä¹°è¿‡é«˜çº§åŒ…æœˆ",
                "coupon": "10å…ƒåˆ¸"
            },
            {
                "segment": "æ–­çº¦ ä¸” æœªè´­ä¹°è¿‡é«˜çº§åŒ…æœˆ",
                "coupon": "10å…ƒåˆ¸"
            }
        ]
    },
    "adv_year_free": {
        "summary": "699å…ƒé¦–è´­ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰",
        "rules": []
    },
    "basic_year_latent": {
        "summary": "å¥åº·åº¦æµ‹è¯•å‘åˆ¸ä¸­",
        "rules": [
            {
                "segment": "åœ¨çº¦å~åˆ°æœŸå‰T-30",
                "coupon": "åŸºäºä¸åŒå¥åº·åº¦ï¼Œä½œé«˜çº§å¹´å¡50~100å…ƒå‘åˆ¸&ä¿ƒæ´»å¼•å¯¼"
            }
        ]
    },
    "basic_year_peak": {
        "summary": "å¥åº·åº¦æµ‹è¯•å‘åˆ¸ä¸­",
        "rules": [
            {
                "segment": "åˆ°æœŸT-30~T+90",
                "coupon": "åŸºäºä¸åŒå¥åº·åº¦ï¼Œä½œåŸºç¡€å¹´å¡70~130å…ƒå‘åˆ¸&ä¿ƒæ´»å¼•å¯¼"
            }
        ]
    },
    "basic_year_churn": {
        "summary": "å¥åº·åº¦æµ‹è¯•å‘åˆ¸ä¸­",
        "rules": [
            {
                "segment": "åˆ°æœŸåT+90",
                "coupon": "åŸºäºä¸åŒå¥åº·åº¦ï¼Œä½œåŸºç¡€å¹´å¡130å…ƒ&ä¿ƒæ´»å¼•å¯¼"
            },
            {
                "segment": "åˆ°æœŸåT+90",
                "coupon": "åŸºäºä¸åŒå¥åº·åº¦ï¼ŒåŸºç¡€åŒ…æœˆ11å…ƒå‘åˆ¸&ä¿ƒæ´»å¼•å¯¼"
            }
        ]
    },
    "basic_month_peak": {
        "summary": "é«˜çº§åŒ…æœˆ89å…ƒå‡çº§ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰",
        "rules": [
            {
                "segment": "åˆ°æœŸT-5~T+7",
                "coupon": "é«˜çº§åŒ…æœˆ89å…ƒå‡çº§ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰"
            }
        ]
    },
    "adv_month_churn": {
        "summary": "89å…ƒç»­çº¦ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰",
        "rules": [
            {
                "segment": "åˆ°æœŸT+10~",
                "coupon": "é«˜çº§åŒ…æœˆ89å…ƒç»­çº¦ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰"
            }
        ]
    },
    "adv_year_churn": {
        "summary": "é«˜çº§å¹´å¡899å…ƒç»­çº¦ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰",
        "rules": [
            {
                "segment": "æ–­çº¦T+30~",
                "coupon": "é«˜çº§å¹´å¡899å…ƒç»­çº¦ä»·ï¼ˆä¼˜æƒ åˆ¸ï¼‰"
            }
        ]
    }
};
// ==========================================

const app = createApp({
    setup() {
        const stages = [
            { key: 'free', name: 'å…è´¹ç”¨æˆ·', desc: 'æœªä»˜è´¹/æ–°å®¢' },
            { key: 'latent', name: 'åœ¨çº¦æ½œä¼æœŸ', desc: 'åˆ°æœŸ T-30å‰' },
            { key: 'peak', name: 'ç»­çº¦é«˜å³°æœŸ', desc: 'åˆ°æœŸ T-30 ~ T+90' },
            { key: 'churn', name: 'æ–­çº¦æµå¤±ç”¨æˆ·', desc: 'åˆ°æœŸ T+90å' }
        ];
        const products = [
            { key: 'basic_month', name: 'åŸºç¡€/æ ‡å‡†\nè¿ç»­åŒ…æœˆ' },
            { key: 'basic_year', name: 'åŸºç¡€/æ ‡å‡†\nå¹´å¡' },
            { key: 'adv_month', name: 'é«˜çº§/è¿›é˜¶\nè¿ç»­åŒ…æœˆ' },
            { key: 'adv_year', name: 'é«˜çº§/è¿›é˜¶\nå¹´å¡' }
        ];

        // ä¼˜å…ˆä½¿ç”¨ç¡¬ç¼–ç æ•°æ®ï¼ˆå‘å¸ƒç‰ˆï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•è¯»å–æœ¬åœ°ï¼ˆç¼–è¾‘ç‰ˆï¼‰
        const strategyData = ref(Object.keys(HARDCODED_DATA).length > 0 ? JSON.parse(JSON.stringify(HARDCODED_DATA)) : {});
        
        const drawerVisible = ref(false);
        const codeDialogVisible = ref(false);
        const generatedCode = ref('');
        const currentEditKey = ref('');
        const currentCell = ref({ summary: '', rules: [] });
        const currentTitle = ref('');

        onMounted(() => {
            initChart();
            // å¦‚æœç¡¬ç¼–ç æ˜¯ç©ºçš„ï¼Œå°è¯•è¯»å–ä¸€ä¸‹æœ¬åœ°ç¼“å­˜ï¼Œæ–¹ä¾¿ç¬¬ä¸€æ¬¡ç¼–è¾‘
            if (Object.keys(HARDCODED_DATA).length === 0) {
                 const saved = localStorage.getItem('crm_temp_draft');
                 if (saved) strategyData.value = JSON.parse(saved);
            }
        });

        const openEditor = (product, stage) => {
            const key = `${product.key}_${stage.key}`;
            currentEditKey.value = key;
            currentTitle.value = `ç¼–è¾‘: ${product.name.replace('\n','')} - ${stage.name}`;
            if (strategyData.value[key]) {
                currentCell.value = JSON.parse(JSON.stringify(strategyData.value[key]));
            } else {
                currentCell.value = { summary: '', rules: [] };
            }
            drawerVisible.value = true;
        };

        const saveTemp = () => {
            strategyData.value[currentEditKey.value] = JSON.parse(JSON.stringify(currentCell.value));
            // é¡ºæ‰‹å­˜ä¸ªæœ¬åœ°ç¼“å­˜ï¼Œé˜²æ­¢åˆ·æ–°ç½‘é¡µç™½å†™äº†
            localStorage.setItem('crm_temp_draft', JSON.stringify(strategyData.value));
            ElMessage.success('æš‚å­˜æˆåŠŸï¼Œè®°å¾—ç‚¹é¡¶éƒ¨çš„â€œç”Ÿæˆé…ç½®ä»£ç â€');
            drawerVisible.value = false;
        };

        const exportDataCode = () => {
            const jsonString = JSON.stringify(strategyData.value, null, 4);
            // ç”Ÿæˆæ•´æ®µä»£ç 
            generatedCode.value = `const HARDCODED_DATA = ${jsonString};`;
            codeDialogVisible.value = true;
        };

        const copyToClipboard = () => {
            navigator.clipboard.writeText(generatedCode.value).then(() => {
                ElMessage.success('ä»£ç å·²å¤åˆ¶ï¼å¿«å»ä¿®æ”¹ HTML æ–‡ä»¶å§');
            });
        };

        const addRule = () => currentCell.value.rules.push({ segment: '', coupon: '' });
        const removeRule = (index) => currentCell.value.rules.splice(index, 1);
        const hasData = (pKey, sKey) => strategyData.value[`${pKey}_${sKey}`] && strategyData.value[`${pKey}_${sKey}`].summary;
        const getCellData = (pKey, sKey) => strategyData.value[`${pKey}_${sKey}`];

        const initChart = () => {
            const myChart = echarts.init(document.getElementById('chart-container'));
            myChart.setOption({
                grid: { top: 10, bottom: 0, left: 0, right: 0 },
                xAxis: { show: false, type: 'category', data: [1,2,3,4,5,6,7,8] },
                yAxis: { show: false, type: 'value' },
                series: [{
                    data: [80, 20, 20, 25, 90, 30, 25, 20],
                    type: 'line', smooth: true, symbol: 'none',
                    lineStyle: { color: '#409EFF', width: 4 },
                    areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(64,158,255, 0.4)' }, { offset: 1, color: 'rgba(64,158,255, 0)' }]) }
                }]
            });
            window.onresize = () => myChart.resize();
        };

        return {
            stages, products, drawerVisible, codeDialogVisible, generatedCode,
            currentTitle, currentCell,
            openEditor, saveTemp, exportDataCode, copyToClipboard, addRule, removeRule, hasData, getCellData
        };
    }
});
for (const [key, component] of Object.entries(ElementPlusIconsVue)) app.component(key, component)
app.use(ElementPlus);
app.mount('#app');
</script>
</body>
</html>
